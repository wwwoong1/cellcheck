pipeline {
    agent any
    tools {
        nodejs 'node18'
    }
    environment {
        GIT_CREDENTIALS_ID = 'GitLab-PAT'
        FRONT_PROJECT_DIR = "cellcheck-fe"
        DIST_DIR = "cellcheck-fe/dist"
        NGINX_HTML_DIR = "/home/ubuntu/docker-services/nginx/html"
    }
    stages {
        stage('Checkout Code') {
            steps {
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: 'develop-fe']],
                    userRemoteConfigs: [[
                        url: 'https://lab.ssafy.com/s12-final/S12P31D106',
                        credentialsId: "${GIT_CREDENTIALS_ID}" // 'GitLab-PAT' ID ì‚¬ìš©
                    ]]
                ])
                sh 'echo "âœ… ì½”ë“œ ì²´í¬ì•„ì›ƒ ì™„ë£Œ"'
            }
        }

        
        stage('Build Frontend') {
            steps {
                dir("${FRONT_PROJECT_DIR}") {
                    sh '''
                    echo "âœ… í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ì‹œì‘"
                    rm -rf node_modules dist
                    npm install --legacy-peer-deps
                    npm run build
                    echo "âœ… í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ì™„ë£Œ"
                    '''
                }
            }
        }
        
        stage('Deploy to Nginx') {
            steps {
                sh """
                echo "[INFO] Nginx ë””ë ‰í† ë¦¬ ìƒì„±..."
                mkdir -p ${NGINX_HTML_DIR}
                
                echo "[INFO] ê¸°ì¡´ íŒŒì¼ ì‚­ì œ ì¤‘..."
                rm -rf ${NGINX_HTML_DIR}/*
                
                echo "[INFO] ìƒˆë¡œìš´ ë¹Œë“œ íŒŒì¼ ë³µì‚¬ ì¤‘..."
                cp -r ${DIST_DIR}/* ${NGINX_HTML_DIR}/
                
                echo "[INFO] ê¶Œí•œ ì„¤ì •..."
                chmod -R 755 ${NGINX_HTML_DIR}
                
                echo "[INFO] Nginx ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘ ì¤‘..."
                cd /home/ubuntu/docker-services
                docker restart nginx
                echo "[INFO] ë°°í¬ ì™„ë£Œ âœ…"
                """
            }
        }
    }
    
    post {
        success {
            echo "ğŸ‰ ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
        }
        failure {
            echo "âŒ ë°°í¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."
        }
    }
}